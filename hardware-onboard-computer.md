Бортовой компьютер: требования индуцированные ПО.
=================================================

Бортовой компьютер и его операционная система должны обладать следующими свойствами:

* Достаточная производительность:
    * работы подсистемы управления движением (на текущий момент RPI2 хватает с 5-кратным запасом при длительности цикла 56 мс).
    * построение изображений глаз.
* Работа в реальном времени для точного выдерживания циклов подсистемы управления движением. 
    * Цикл управления (56 мс) вкалючаяет множество переключений контекстов между нитями (порядка 10).
    * промежутки между посылкой команд приводам  по UART (5 мс на один обмен, из них 2 мс заложены на задержки ОС)
* Работоспособная периферия 
    * UART --- 3 порта для управления приводами
    * SPI --- отображение глаз на старых экранах.
    * HDMI --- перспективный метод отображения глаз. 
    * I2C --- взаимодействие с переферией.
    * звуковой интерфейс или I2S для подключения кодека.
    * ethernet/wifi для соединения с компьютером оператора.
    При этом наиболее жестки требованияк к UART: задержки в циклах опроса приводов должны быть минимальны. 
    Для SPI стоит требования надежности буфферизации, при отобраджении глаз он загружен на полную пропускную способсность.
* Операционная система на базе дистрибутив Debian.

#### Аппаратная часть

* Rashberry PI3 (4-х ядерный BCM2837, 1.4 MGz, 1 GB)
    Плюсы:
    * поддержка со стороны сообщества,
    * существуют rt-версии ядра,
    Минусы:
    * один UART,
    * баг в реализации I2C не позволяет подключать блок питания напрямую,
    * неудачный дизайн USB: на нем сидит Ethrernet, что может не дать использовать, например, решения с USB-UART преобразователями.
    Особенности:
    * Можно добиться аппаратного ускорения графики, но по факту пока не получилось.
    **Вывод**: малое число интерфейсов (в особенности UART), проблемы с I2C. Для полноценного примения нужны два расширения: дополнительные порты UART, SPI->I2C. 

* Tinker Board (4-х ядерный rk3288, 1.9 MGz, 2 GB)
    Плюсы:
    * большой запас вычислительной мощности
    * встроенный звуковой кодек
    Минусы:
    * нестабильность пары 3xUART+SPI: на изображении экрана разрывы (баг с DMA?),
    * из коробки сложности с чтением EDID и отображением через HDMI на экраны глаз,
    * отсутствие rt-версий ядра: патчи для rk3288 конфликтуют с RT-патчем  https://tinkerboarding.co.uk/forum/archive/index.php/thread-612.html
    * высокое энергопотребление
    Особенности: 
    * Несколько образов:     https://tinkerboarding.co.uk/forum/archive/index.php/thread-69.html
         * Официальный --- старое "фиксированное" плохо обновряемое ядро: https://github.com/TinkerBoard/debian_kernel
         * Armbian --- `mainline` ядро c патчами лучше поддерживается сообществом, но нет прямой поддержки производителя. Есть бинарные образы: https://www.armbian.com/tinkerboard/
         * Чистый stretch + [ядро rockchip](https://github.com/rockchip-linux/kernel) --- еще меньше поддержки: https://www.tinkerboarding.co.uk/forum/thread-22-post-5512.html
    * Получение аппаратное ускорение графики для неофициальной версии прошивки сопряжено с трудностями: https://forum.armbian.com/topic/6506-tutorial-3d-video-acceleration-and-opencl-in-rk3288-boards-with-new-44-default-kernel/
    **Вывод**: основные проблемы в программной области. Либо он легко устранятся (выбор подходящего ядра), либо могут быть принципиально неустранимыми.

* Beagle Board (1-ядрерный AM335x, 1GHz, 1GB) 
    Плюсы:
    * сообщество
    * периферия
    Минусы:
    * малая вычислительная мощность
    **Вывод**: отказ из-за недостаточной мощности (напрмер, отрисока глаз потенциально возможно только при помощи ускорителя).

#### Устранение проблем связанных с недостаточным числом UART

Варианты:

1. Использовать `TinkerBoard`. Проблема с "разрывами изображения" SPI глаз, также не удалось нормально использовать HDMI.
    Причин может быть множество:
    1. Аппаратный баг SoC или плохой SPI/UART модуль ядра --- тестировать другие ядра.
    2. Проблем в стеке `QT` -> `fbdev` -> `SPI` --- протестировать без QT, снизить fps.

2. Использовать `RPI3` + `USB-UART` (`ft4332`). Дополнительное устройство, завязка на используемую ethernet шину USB, сохраняется проблема с I2C (еще одно внешнее устройство в виде `SPI-I2C`)
    Ожидаются бОльшие задержки. 

3. Использовать `RPI3` + `SPI-UART` (`max14830`), [подробнее](http://akheh.blogspot.com/2016/06/using-max14830-with-raspberry-pi-3.html).  Дорогая редкая микросхема, очень дорогая тестовая плата, занимает SPI слот, сохраняется проблема с I2C (т.е. надо 4 SPI устройства: 2 экрана + 2 моста).
    Вероятно лучший вариант по добавлению UART к RPI. Задержки зависят от драйвера и настроек встроенной FIFO.

4. Использовать `RPI3` + [`SPI-UART` на базе МК](https://www.instructables.com/id/SPI-to-4-x-UART-Bridge-MULTIUART/) Требует модификаций `HerkulexDriver`, занимает SPI слот, сохраняется проблема с I2C (т.е. надо 4 SPI устройства: 2 экрана + 2 моста).  Хороший вариант с полным контролем задержек. Однако требует переписывания драйвера.

5. Другой SoC. У него будет свой набор проблем.

Порядок приоритета: 1, 2, 4. Однако надо принять четкое решение относительно UART.

#### Тестирование

Необходимо имитировать характерную нагрузку без непосредственного запуска системы управления и без переконфигурации ядра (желательно). 

Синтетическая нагрузка включает:

1. [serial-delay-test](https://gitlab.com/sweetie-bot/serial-delay-test) Имитировать обмен по UART, использовать скрипт `serial-delay-test.sh` с сохранением статистики (см. встроенную справку). Для тестирования нескольких портов запускать скрипты параллельно. Приоритет реального времени 60, планировщик FIFO.
2. Имитация  работы модуля глаз. Вывод в `fbdev` изображения и мониторинг его на подключенном экране на наличие дефектом.  SPI линия должна быть загружена полностью. 
3. `hackbench` в фоне для загрузке ЦПУ. (Тест проводится с ним и без него).



