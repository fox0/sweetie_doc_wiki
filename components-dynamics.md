Динамика `dynamics_inv`
=======================

Компонент по параметрам движения (позиция, скорость) в угловой системе координат, позиции и скорости платформы и списку контактов рассчитывает моменты приводов и силы реакции опоры.
Эта информация используется, чтобы формировать задания на приводы.

Использует вспомогательный класс [`RobotModel`](plugin-robotmodel) для загрузки модели робота и задания цепочек. 

### Входные порты

1. `joints_sorted` (`JointState`) --- состояние робота в угловой СК: позиции, скорости. Полная поза робота.
1. `base` (`RigidBodyState`, EventPort) --- позиция и скорость платформы в неподвижной СК.
1. `supports_sorted` (`SupportState`) --- список активных контактов и их типы.
1. `sync_step` (`int`) --- синхронизация с таймером.

### Выходные порты

1. `joints_accel_sorted` (`JointStateAccel`) --- состояние робота в угловой СК: позиции, скорости, ускорения и моменты приводов. Отсорт
1. `wrenches` (`RigidBodyState`) --- позиции, скорости последних звеньев кинематических цепочек неподвижной СК, расчетные силы реакции опоры, действующие на них.
2. `base` (`RigidBodyState`) --- позиция, скорость основания робота неподвижной СК, расчетные силы реакции опоры приведенные к ней.
1. `balance` (`BakanceState`) --- информация о устойчивости робота: опорный многоугольник, масса, положение центра масс и центра давления.

### Параметры

2. `robot_description` (`string`) --- URDF модель робота. Динамика использует модель без фиктивных звеньев, используемых для упрощения задачи обратной кинематики.
2. `legs` (`strings`) --- список ног (кинематических цепочек, которые могут быть использованы в качестве опорных).
4. `tolerance` (`double`) --- пороговый параметр, используемый для определения ранга якобиана контактов.

### Операции

### Сервис и плагины

1. Требует: [`RobotModel`](plugin-robotmodel). 
1. Требует загрузки: дифференцирующий фильтр (второй этап реализации).

### Семантика исполнения

**Конфигурация**. Загрузка модели.

**Исполнение**. Решает обратную задачу динамики (см. [Robot Dynamics Lecture Notes, section 3.10](https://www.ethz.ch/content/dam/ethz/special-interest/mavt/robotics-n-intelligent-systems/rsl-dam/documents/RobotDynamics2016/RD2016script.pdf)).


Порядок решения выглядит так:

1. Оценить ускорения путем вычисления численных производных входных скоростей.
2. Вычислить совокупный якобиан контактов `Jc(q)`.
3. Проецировать ускорение, так чтобы удовлетворяло ограничениям контактов: `Jc(q)*ddq + JcDot(q, dq)*dq = 0`.
4. Вычислить матрицу инерции `H(q)` и нелинейный член `N(q,dq)` (центробежные и кориолисовы силы, сила тяжести).
5. Вычислить лагранжевы множители `lambda` ограничений контактов, обнуляющие в уравнении динамики ошибку по безприводным (unactuated) степеням свободы 
    (положении и ориентация платформы): 
	
	    Ns*Jc(q)'*lambda = Ns*(H(q)*ddq + N(q,dq)),

    где `Ns` --- матрица-селектор безприводных степеней свободы. 
6. Вычислить моменты приводов: `tau = H(q)*ddq + N(q,dq) - Jc(q)'*lambda`
5. Расчет центра масс, сил реакции опоры, центра давления и точки нулевого момента.

### Детали реализации.

Код расчета производных желательно выделить в отдельную [вспомогательную библиотеку](library-filters): потенциально ей могут пользоваться агрегатор и задатчики.
Имеет смысл использовать полиномиальный дифференцирующий фильтр с КИХ (должен быть очень эффективен при задании траектории сплайнами) или дифференцирующее звено с фильтом первого порядка.

Лучше использовать упрощенную URDF модель без фиктивных и несущественных звеньев (глаза, уши и хвост). Лишние координаты во входной позе просто игнорируются.

Используется библиотека RDBL. Проблему может составить проверка совпадения нумерации приводов.

Расчеты ведутся в инерциальной СК, связанной с землей. 

Для поиска решений (псевдорешений) возникающих СЛАУ предлагается использовать [SVD разложение](https://eigen.tuxfamily.org/dox/group__TutorialLinearAlgebra.html).
Оно демонстрирует лучшую устойчивость, чем остальные варианты.

### Исключения и ошибки

Ошибки:
1. Некорректное имя цепочки.
2. Неполная поза, список контактов.

Предупреждения:
3. Нет контактов.
3. Нарушение условий касания: силы реакции неспособны осуществить заданное движение.

<!--
Динамика `dynamics_fwd`
=======================

Решает прямую задачу кинематики для сил: пересчитывает усилия приводов во внешние силы, действующие на робота.
Первая версия не учитывает инерцию робота, преобразование совершается только за счет кинематики.

### Входные порты

1. `joints_sorted` (`JointState`, EventPort) --- состояние робота в угловой СК: позиции, скорости. Полная поза робота.
1. `body` (`RigidBodyState`) --- позиция и скорость платформы.

### Выходные порты

1. `contacts` (`SupportState`) --- силы реакции опоры для выбранного списка точке (z-компонента силы в заданной точке).
1. `forces` (`WrenchStamped`) --- 6-мерные внешние силы для указанного списка точек (опционально).

### Параметры

2. `contact_list` (`strings`) --- список точек, к которым приводятся внешние силы (задача неоднозначно, например, можно приводить к туловищу и голове, а можно к ногам и голове). 
    Имена соответвуют кинематическим цепочкам, для обозначения туловища используется "body".

### Операции

### Сервисы и плагины

1. Требует загрузки: [`RobotModelURDF`](plugin-robotmodel) для вычисления якобиана.

### Семантика исполнения

Выполняет пересчет моментов приводов к заданным точкам, используя псевдообращение якобиана. (Проверить корректность операции).

### Детали реализации.

Задача сводится к решению переопределенной СЛАУ.

### Исключения и ошибки

Ошибки:
1. Некорректное имя цепочки.
2. Неполная поза.
-->
