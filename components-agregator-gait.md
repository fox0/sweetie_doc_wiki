Компонент `agregator_gait`
================

Минимальная реализация агрегатора. Компонент буферизует входящие сообщение с частичной позой в угловой системе координат,
что позволяет сформировать отсортированную позу.

### Входные порты

1. `joints_in` (`JointState`, EventPort) --- состояние отдельных элементов робота в угловой системе координат (первичная инициализация).
1. `support_in` (`SupportState`) --- опорные коэффициенты. 

### Выходные порты

1. `joints_sorted` (`JointState`) --- состояние робота в угловой системе координат, суставы отсортированы по цепочкам.
1. `support` (`SupportState`) --- опорные коэффициенты.

### Параметры

### Плагины

1. Требует: `robot_model` --- URDF модель робота и его кинематических цепочек [`RobotModelURDF`](components-kinematics). 
    Определяет порядок суставов в отсортированной `JointState`.

### Семантика исполнения

**Конфигурация**. По модели робота и набору кинематических цепочек создать переменные для хранения позы (`JointState`) 
и средства быстрого доступа к ним для осуществления эффективной сортировки.

**Получение сообщения**. Обновление буфера с отсортированным `JointState` посредством полученного сообщения. 
Входной сообщение проверяется на корректность: неизвестные суставы, наличие одновременно скорости и позиции. 
Новая поза публикуется через порт `joints_sorted`. Также обновляется и публикуется `SupportState`.

**Замечание**. При назначении позы имеет смысл проверять жесткие лимиты значений углов и приводить позу к допустимой.

#### Детали реализации.

Вероятно, для ускорения поиска по имени сочленения следует использовать `std::unsorted_map`. 
(Для приводов и для цепочек и индексами или ссылками нужных структур и элементов: сквозной номер привода, номер цепочки, номер привода в цепочке).

Буфер логичнее строить на `JointState`, поскольку могут быть приводы не принадлежащие ни одной цепочке. 

Входной порт должен читаться в коде компонента в цикле, пока не будет получено `OldValue`.

### Варианты использования

Перед использованием требуется первичная инициализация позы.  

Основная функция --- агрегация и восстановление состояния робота. 
Помимо объединения выходов задатчиков она может применяться для объединения показаний датчиков позиции приводов.

### Ошибки и исключения

Предупреждения:
2. Выход за лимиты.
1. Незнакомый привод, цепочка.

Ошибки:
1. Целостность входных данных нарушена: несовпадение размеров массивов с требуемым значением.

Компонент `agregator_gait_sync`
================

Сложная реализация агрегатора с интегрирование, дифференцированием и интерполяцией.

### Входные порты

1. `joints_in` (`JointState`, EventPort) --- состояние отдельных элементов робота в угловой системе координат (первичная инициализация).
1. `support_in` (`SupportState`) --- опорные коэффициенты. 
2. `sync` (`TimerEvent`, EventPort) --- синхронизация, извещение о конце цикла управления. 

### Выходные порты

1. `joints_sorted` (`JointState`) --- состояние робота в угловой системе координат, суставы отсортированы по цепочкам.
1. `support` (`SupportState`) --- опорные коэффициенты.

### Параметры

1. `quad_method` (`string`) --- метод численного интегрирования.
1. `diff_method` (`string`) --- метод численного дифференцирования.
1. `update_method` (`string`) --- метод обновления элементов буфера позы, для которых не было получено нового значения (опционально).
-->
### Плагины

1. Требует: `robot_model` --- URDF модель робота и его кинематических цепочек (`RobotModelURDF`)

### Семантика исполнения

**Конфигурация**. По модели робота и набору кинематических цепочек создать переменные для хранения позы (`JointState`) 
и средства быстрого доступа к ним для осуществления эффективной сортировки.

**Получение сообщения `sync`**. Изменить номер текущего цикла, применить метод `update` для для всех фильтров. 
Предсказать будущие значения элементов буфера позы в зависимости от политики `update_method`. 
Это позволяет получить сразу значения "по умолчанию" для координат, которые не будут обновлены.

**Замечание**. Политика обновления `update_method` по `sync` стояний приводов может быть разная. 
* Сохранение предыдущего значения.
* Сохранение предыдущего значения позиции с обнулением скорости.
* Интерполяция позиции, используя скорость. 
* Плавное торможение.
На первом этапе имеет смысл ограничится первым методом.

**Получение сообщения**. Общий алгоритм обработки сообщения следующий:
1. Проверить корректность номера цикла: должно равняться текущему или ноль (отсутствует).
2. Для каждого сустава:
    * Если в наличии скорость и позиция,  сбросить фильтры, присвоить буферным переменным новые значения.
    * Если в наличии скорость или позиция, применить соответствующий фильтр, сбросить другой, присвоить буферам новые значения.
    Сообщения сохраняются в буфер `JointState` в порядке установленном `robot_model`.
3. Обработать момент `effort`, если присутствует.
4. Обработать `SupportState`.
5. Обновить выходные порты.

**Замечание**. Поскольку компонент содержит динамические элементы (интеграторы и дифференциаторы), то необходима привязка к реальному времени.
Это решается введением порта `sync`. Альтернативный вариант --- слежение за сменой номеров цикла управления во входящих сообщениях.

**Замечание**. При назначении позы имеет смысл проверять жесткие лимиты значений углов и приводить позу к допустимой.

#### Детали реализации.

Вероятно, для ускорения поиска по имени сочленения следует использовать `std::unsorted_map`. 
(Для приводов и для цепочек и индексами или ссылками нужных структур и элементов: сквозной номер привода, номер цепочки, номер привода в цепочке).

Буфер логичнее строить на `JointState`, поскольку могут быть приводы не принадлежащие ни одной цепочке. 

Входной порт должен читаться в коде компонента в цикле, пока не будет получено `OldValue`.

### Варианты использования

Перед использованием требуется первичная инициализация позы.  

Основная функция --- агрегация и восстановление состояния робота. 
Помимо объединения выходов задатчиков она может применяться для объединения показаний датчиков позиции приводов.

### Ошибки и исключения

Предупреждения:
1. Несогласование цикла управления.
2. Выход за лимиты.
1. Незнакомый привод, цепочка.

Ошибки:
1. Целостность входных данных нарушена: несовпадение размеров массивов с требуемым значением.
