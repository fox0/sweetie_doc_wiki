Кинематика `kinematics`
=======================

Компонент предоставляет средства решения задач кинематики (прямой, обратной, мгновенной) 
и ряд вспомогательных преобразований.

Предоставляются разные интерфейсы: порты, операции.

### Входные порты

Прямая кинематика

1. `in_joints_sorted` (`JointState`) --- состояние робота в угловой СК (отсортированная).

Обратная кинематика

1. `in_limbs_fixed` (`RigidBodyState`) --- состояние робота в декартовой СК (желаемая или реальная по датчикам).
2. `in_joints_seed` (`JointState`) --- текущее состояние робота в угловой СК (отсортированное), первое приближение для решения задачи обратной кинематики.

### Выходные порты

Прямая кинематика

1. `out_limbs` (`CartesianState`) --- состояние робота в декартовой СК (желаемая или реальная по датчикам).

Обратная кинематика

1. `out_joints` (`JointState`/`JointLimbState`) --- состояние робота в угловой СК (желаемая или реальная по датчикам).


### Параметры

Прямая кинематика:
1. `strings kinematics_chains` --- имена кинематических цепочек, для которых проводится расчет. 
	Этот же параметр определяет порядок цепочек в выходном сообщении.
2. `bool virtual_links` --- прямая кинематика рассчитывается и для виртуальных сочленений на концах цепочек.

Обратная кинематика:
1. `strings kinematics_chains` --- имена кинематических цепочек, для которых проводится расчет. 
2. Различные параметры для алгоритма расчета обратной задачи кинематики: максимальное число итераций, максимальное время выполнения, 
    параметры детектирования вырождения якобиана и т.п.
3. `bool zero_vel_at_singularity` --- обнуление скорости, если якобиан вырождается. Позволяет избежать выбросов скорости вблизи вырожденных точек.
4. `double[] <chain>_q_max`, `double <chain>_q_min>` --- лимиты для сочленений при решении обратной задачи кинематики. Массив для каждой кинематической 
    цепочки. Загружаются из .cpf файла.

### Операции

Обратная кинематика:
1. `bool poseToJointState(const RigidBodyState& pose, JointState& joints)` --- синхронный вызов обратной кинематики. Возвращает `true`, если решение найдено.
2. `bool poseToJointStatePublish(const RigidBodyState& pose)` --- синхронный вызов обратной кинематики. Возвращает `true`, если решение найдено,
    Публикует через порт `out_joints`.

Основное назначение этих операций --- снабдить вызывающий компонент информацией о том, удалось ли решить задачу обратной кинематики.
Использование портов затрудняет эту задачу. 

### Сервисы и плагины

1. Требует загрузки: [`RobotModel`](plugin-robotmodel) --- предоставляет доступ к модели робота.

### Семантика исполнения

Операции прямиком транслируются в обращения к библиотеке кинематики.

### Детали реализации.

Плагин `RobotModel` выносится функциональность по загрузке URDF, выделению цепочек, разрешению имен. 
Он используются реализациями кинематики на базе различных библиотек.

Потенциально задачу обратной кинематики для разных цепочек можно решать в отдельных нитях. 
Однако не ясно, даст ли это практический выигрыш. К примеру, `trac_ik` и так использует два потока.

Для решения задачи обратной кинематики используются кинематические цепочке, дополненные виртуальными звеньями.
Это позволяет избежать сингулярностей (вырождение якобиана) и делает процесс поиска решения более устойчивым. 
если в кинематической цепочке меньше 6 степеней свободы.

Однако в определенных позах якобиан все равно вырождается (например, нога выпрямлена). Эти ситуации следует 
обрабатывать отдельно (параметр `zero_vel_at_singularity`) для избежания 

Потенциальные библиотеки: `KDL`, `RBDL`, `trac_ik`.

### Исключения и ошибки

TODO Уточнить, отсортировать.

1. Некорректное имя цепочки
2. Решение не найдено
3. Нарушение ограничений (лимитов)

