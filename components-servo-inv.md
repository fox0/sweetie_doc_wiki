Обращение модели приводов `servo_inv_*`
=======================


Компонент рассчитывает задание для приводов с дискретным позиционным управлением 
по парамерам желаемой траектории (позиция, скорость) и необходимому моменту.

Компонент  `servo_inv_lead`
---------------------------

Рассчитывает целевую позицию привода исходя из предположение, что ПИД-регулятор привода обеспечивает точную отработку заданной позиции.
Формирует упредение на заданное число циклов управления.

### Входные порты

1. `joints_fixed` (`JointState`, EventPort) --- желаемое состояние для приводов, порядок приводов не меняется.

1. `sync_step` (`int`) --- порт индикации начала нового цикла управления.

### Выходные порты

1. `goals` (`ServoGoal`) --- задания для приводов.

### Параметры

1. `period` (`float`) --- длительность цикла управления, секунды.

1. `lead` (`float`)  --- упреждение в секундах.

### Операции

Отсутсвуют.

### Семантика исполнения

Предполагается, что генератор траектории привода настроен в режиме прямоугольной скорости. (Нулевая длительность фазы ускорения по отношению длительности движения для приводов Herkulex).
По получению нового желаемого состояния, происходит вычисление комады для приводов по формуле:

    servo_goal_position = desired_position + (desired_position - previous_desired_position) * lead / period
    servo_gaol_duration = laed + period


### Исключения и ошибки

Предупреждения:
1. Изменение числа приводов.


Компонент  `servo_inv_7param`
---------------------------

Использует статическую 7-параметрическую модель привода из проекта NimbRo-OP. Модель учитывает изменения напряжения питания, силу трения (вязкую, Кулона, Штрибека).
При формировании комады для привода берется упреждение.

### Входные порты

1. `joints_fixed` (`JointState`, EventPort) --- желаемое состояние для приводов, порядок приводов не меняется.

1. `servo_model` (`ServoModel`) --- порт для обновления списка иоделей приводов. Используется для передачи модели от модуля идентификации к компоненту. 
    Модель добавляется или заменяет соответвующую в списке моделей (параметр модуля).

1. `sync_step` (`int`) --- порт индикации начала нового цикла управления. 

2. `battery_state` (`sensor_msg::BatteryState`) --- состояние батареи, в частности напряжение питания приводов.

### Выходные порты

1. `goals` (`ServoGoal`) --- задания для приводов.

### Параметры

1. `period` (`float`) --- длительность цикла управления, секунды.

1. `lead` (`float`)  --- упреждение в секундах.

1. `servo_models` (`ServoModel[]`)  --- список моделей приводов. 

1. `battery_voltage` (`double`)  --- напряжение батареи по умолчанию.

### Операции

Отсутсвуют.

### Семантика исполнения

Предполагается, что генератор траектории привода настроен в режиме прямоугольной скорости. (Нулевая длительность фазы ускорения по отношению длительности движения для приводов Herkulex).

**Запуск** или **обработка первого сообщения**: проверяется корректен ли список моделей (нет дублирующихся, возможно, диапазоны парметров) 
и устанавливается соответвие с полученной позой и элементами списка. Если модель привода в списке отсутсвует, то соответвующее соленеиеи не будет обрабатываться.


**Исполнение**. Получает задающее воздействие для каждого звена в виде тройки позиция, скорость, развиваемый момент. Используя эти значения рассчитывает
команду для привода `goals` [Compliant Robot Behavior using Servo Actuator Models identified by Iterative Learning Control], перед посылкой команды берет упреждение по тому же алгоритму, что `servo_inv_lead`. 

**Сообщение `servo_model`**. Предназаначено для обновления моделей, когда компонент запущен. Находит соотвевующую модель с списке моделей и заменяет ее. 
Все действия исполняются после обработки `joints` и формирования `goals`.


* При необходимости переупорядочевается список моделей, чтобы он в соответвовал порядку сочленения в `JointState`. Установление сообветвия между моделями 
* Если нужной модеи нет в списке, то в соответвующую позицию добавляется "пустая" модель.


### Детали реализации

Т.к. порт `joints` декларирован как `fixed`, то в процессе исполнения порядок звеньев не меняется, что можно использовать для выборки нужной модели.
Соответвенно возможны разные способы установления связи между списком моделей и приводами. 
1. По имени. Создается `map<string,ServoModel>` или `map<string,ServoModel&>`, по которому находится соответвующая модель или номер ее в списке моделей. 
    Минусы: медленно, дополнительные структуры данных.
2. По позиции в списке моделей. При инициализации список моделей переупорядочивается с соотвевие с порядком сочленений  в `JointState`. 
    Добавлются "нулевые" модели, если модель в списке отсутвует.
    Минусы: операция обновления модели в активном состонии требует поиска по именам сложности N.
3. По позиции в `JointState`. Создание отдельного от параметрв `servo_models` упорядоченного списка моделей.
    Минусы: дополнительная структура данных, длительность выборки по имени.
Реккомендуемый вариант: 2.

### Исключения и ошибки

Предупреждения:
1. Изменение числа приводов.
1. Отсутвие модели для привода, лишние модели.

